<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>利用AWS Instance Scheduler 達成EC2 &amp; RDS 自動開/關機 | Apuntes</title>
    <meta name="description" content="Scott Lin&#39;s notes">
    <link rel="icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    
    <link rel="preload" href="/assets/css/0.styles.5bfd9109.css" as="style"><link rel="preload" href="/assets/js/app.87383360.js" as="script"><link rel="preload" href="/assets/js/2.93c13480.js" as="script"><link rel="preload" href="/assets/js/7.288d3c81.js" as="script"><link rel="prefetch" href="/assets/js/10.cf85d75f.js"><link rel="prefetch" href="/assets/js/11.8455bbe6.js"><link rel="prefetch" href="/assets/js/12.aa33f2ce.js"><link rel="prefetch" href="/assets/js/13.3e131f68.js"><link rel="prefetch" href="/assets/js/14.1b352e0b.js"><link rel="prefetch" href="/assets/js/15.ae7b52ca.js"><link rel="prefetch" href="/assets/js/3.99a4b7c3.js"><link rel="prefetch" href="/assets/js/4.13646481.js"><link rel="prefetch" href="/assets/js/5.4bc23bcd.js"><link rel="prefetch" href="/assets/js/6.00fab48d.js"><link rel="prefetch" href="/assets/js/8.dc9a40d4.js"><link rel="prefetch" href="/assets/js/9.84c114a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5bfd9109.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Apuntes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="content default"><h1 id="利用aws-instance-scheduler-達成ec2-rds-自動開-關機"><a href="#利用aws-instance-scheduler-達成ec2-rds-自動開-關機" aria-hidden="true" class="header-anchor">#</a> 利用AWS Instance Scheduler 達成EC2 &amp; RDS 自動開/關機</h1> <h5 id="date-2019-april-02"><a href="#date-2019-april-02" aria-hidden="true" class="header-anchor">#</a> Date: 2019/April/02</h5> <p>AWS機器上的花費是相當高的, 當專案仍處在開發階段的時候, 這些機器並不需要24小時都維持開啟的狀態.</p> <p>我們可以透過腳本讓這些EC2或是RDS在指定的時段裡啟動, 下班之後就把機器關掉節省開銷.</p> <br> <hr> <h2 id="_60-seconds"><a href="#_60-seconds" aria-hidden="true" class="header-anchor">#</a> 60 seconds</h2> <h3 id="aws幫你準備好了"><a href="#aws幫你準備好了" aria-hidden="true" class="header-anchor">#</a> AWS幫你準備好了</h3> <br> <ul><li>架構</li></ul> <p>到<a href="https://aws.amazon.com/tw/solutions/instance-scheduler/" title="AWS Instance Scheduler" target="_blank" rel="noopener noreferrer">官方頁面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 可以看到這套懶人包的架構:</p> <p><img src="/images/2019/april/cb70e1deb398f3ce74b74c793de1d7d1a2150f9a7dae33419f792a655bac253e.png" alt="架構圖" title="AWS Solution overview"></p> <br> <blockquote><p>用<strong>AWS CloudWatch Events</strong> (以時間為條件, 類似cronjob, 這邊用來調整觸發<strong>頻率</strong>) 觸發<strong>Lambda</strong>程式 (AWS寫好了, 基於python),</p> <p>去檢查目標的執行狀態, 再按照<strong>DynamoDB</strong>裡設定的細節執行開關機.</p></blockquote> <br> <ul><li>使用CloudFormation佈署基礎服務</li></ul> <p>一樣是在剛剛的官方頁面, 可以看到 <strong>Launch solution in the AWS Console</strong>的按鈕,<br>
按下去以後就會進到CloudFormation的頁面, 並開始設定細節.</p> <p>進不去該頁面的同學請先確認你的<strong>IAM</strong>裡有開啟CloudFormation的權限.</p> <p><img src="/images/2019/april/48018e1af8c10f2731359f431c8d7213d9cb731dc7b93fad8217f16e82a03ac5.png" alt="按下下一步" title="AWS自動填入了Scheduler的模板, 按下Next即可"></p> <br> <p>當然, 你也可以用<em>View/Edit template in Designer</em>查看接下來AWS會幫你開啟/創建哪些服務.</p> <p><img src="/images/2019/april/9627a0853bd495f52df4837eda2b5fd07e12c83089dd3ab8aa091630719f03b6.png" alt="CloudFormation template" title="CloudFormation template"></p> <br> <p>下一頁會進到Options, 要特別注意權限的設定. 這邊也能設定排程出錯時的處置選項.<br>
之後就等待CloudFormation將整組服務建立起來.</p> <p><img src="/images/2019/april/2183c72c3c752ce3f4b7e1779bf829d065185f5ba93f3c9d1ea01b1e5818e70b.png" alt="Parameters" title="參數說明"></p> <p>※註1: <strong>Instance Scheduler tag name</strong>是之後在EC2/RDS上指定哪些<strong>資源</strong>要套用<em>自動開關機</em>時會用到的, 這裡指定的是<strong>key</strong></p> <br> <ul><li>DynamoDB: 調整時間與排程</li></ul> <p>現在我們要來調整時間與排程了.</p> <p><img src="/images/2019/april/16a696b30864af42938ae92ec669f6e9d7012c4478bbb14c0a4b338de53bdb47.png" alt="DynamoDB page" title="DynamoDB"></p> <br> <p>進入到DynamoDB -&gt; Tables -&gt; 選擇ConfigTable (不要<strong>手動修改</strong>StateTable!)-&gt; Items,</p> <p>能夠看到下面有很多資料. 在這邊我想設定台灣時間09:00到21:00時機器開啟,</p> <p>首先複製(Actions -&gt; Duplicate)一筆時間資料(period), 再做修改:</p> <p><img src="/images/2019/april/6d604a1f57da63aafef62542d6427e8227e5282f2d1d17ca6b429697af137586.png" alt="時間區間" title="period"></p> <p>接著一樣複製一筆排程(schedule)作修改:</p> <p><img src="/images/2019/april/6d604a1f57da63aafef62542d6427e8227e5282f2d1d17ca6b429697af137586.png" alt="排程" title="schedule"></p> <p>這裡的名稱(name)跟上面 <strong>※註1</strong> 提到的tag key有關聯, 等等會提到.</p> <p>總之, 到這邊整個設定就完成了80%.</p> <br> <ul><li>啟動排程開關機服務</li></ul> <p>這裡使用EC2u作為範例,</p> <p><img src="/images/2019/april/925280d6c0935aad3a992ed66da8307882b8d38c30183c37f73fb28ce20deb80.png" alt="EC2 Instances" title="EC2 page"></p> <p>EC2 -&gt; INSTANCES -&gt; 選擇要啟用排程開關機的實例 -&gt; <em>Add/Edit Tags</em></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Key:Value

$(Instance Scheduler tag name):$(DanamoDB-&gt;ConfigTable-&gt;Items-&gt;schedule-&gt;name)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>右邊的值只能選擇當初DynamoDB裡面是排程(type = schedule)的資料,<br>
如果給的值是區間名稱(type = period)的話會報錯.</p> <p><img src="/images/2019/april/ff9e608382107313f3400f7523d0a1f73d4c879c2e6826eef10dca792e0baa1f.png" alt="簡單來說就是這麼回事" title="Instance Scheduler on the AWS Cloud"></p> <h2 id="_60-minutes"><a href="#_60-minutes" aria-hidden="true" class="header-anchor">#</a> 60 minutes</h2> <h3 id="still-building"><a href="#still-building" aria-hidden="true" class="header-anchor">#</a> Still building</h3> <br> <hr> <h2 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h2> <br> <h4 id="其他參考資料"><a href="#其他參考資料" aria-hidden="true" class="header-anchor">#</a> 其他參考資料</h4> <p>Amazon. (2018, Feb. 7). <a href="https://aws.amazon.com/tw/about-aws/whats-new/2018/02/introducing-the-aws-instance-scheduler/" target="_blank" rel="noopener noreferrer">AWS Instance Scheduler 正式推出<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Amazon Web Service.</p> <p>Dulare (20188, Feb. 20). <a href="https://handyman.dulare.com/aws-instance-scheduler-quick-howto/" target="_blank" rel="noopener noreferrer">AWS Instance Scheduler – quick howto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> IT HANDYMAN.</p> <p>Amazon, (2018, October). <a href="https://docs.aws.amazon.com/solutions/latest/instance-scheduler/welcome.html" target="_blank" rel="noopener noreferrer">AWS Instance Scheduler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Amazon Web Service Documentation.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/7/2019, 6:55:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.87383360.js" defer></script><script src="/assets/js/2.93c13480.js" defer></script><script src="/assets/js/7.288d3c81.js" defer></script>
  </body>
</html>
